{% extends 'base.html' %}
{% load static %}
{% load jdatetime_filters %}

{% block title %}
    Ù…Ø´ØªØ±ÛŒØ§Ù† Ø±Ø³ØªÙˆØ±Ø§Ù†
{% endblock %}

{% block stylesheet %}
    <link rel="stylesheet" href="{% static 'orders_list_style.css' %}">
    <link rel="stylesheet" href="{% static 'customers_list_style.css' %}">
{% endblock %}

{% block content %}
    <div class="container">
        <header>
            <div class="brand">
                <div class="logo" aria-hidden="true"></div>
                <div>
                    <h1>Ù…Ø´ØªØ±ÛŒØ§Ù† Ø±Ø³ØªÙˆØ±Ø§Ù† Ø¨Ø²Ø±Ú¯Ù…Ù‡Ø±</h1>
                    <div class="subtitle">Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒØ§Ù†</div>
                </div>
            </div>
            <div class="actions">
                <a class="btn" href="{% url 'order_list_url' %}" data-tip="Ø³ÙØ§Ø±Ø´Ø§Øª">
                    Ø³ÙØ§Ø±Ø´Ø§Øª
                </a>
            </div>
        </header>

        <!-- Customers -->
        <section class="customers">
            {% for customer in customers %}
                <article class="card customer-card">
                    <div class="card-head">
                        <div style="display:flex; gap:10px; align-items:center; justify-content: space-between; width: 100%;">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <div class="avatar" aria-hidden="true">
                                    <svg
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            xmlns="http://www.w3.org/2000/svg"
                                    >
                                        <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5Zm0 2c-4.418 0-8 2.239-8 5v2h16v-2c0-2.761-3.582-5-8-5Z"
                                              fill="currentColor" opacity=".7"/>
                                    </svg>
                                </div>
                                <div>
                                    <div class="name">{{ customer.name }}</div>
                                    <div class="phone">{{ customer.phone_number }}</div>
                                </div>
                            </div>
                            <button class="delete-customer-btn" 
                                    data-customer-id="{{ customer.id }}"
                                    data-customer-name="{{ customer.name|escapejs }}"
                                    data-customer-phone="{{ customer.phone_number|escapejs }}"
                                    title="Ø­Ø°Ù Ù…Ø´ØªØ±ÛŒ">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" 
                                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="rows">
                        {% with all_addresses=customer.get_all_addresses %}
                        {% if all_addresses %}
                        <div class="row">
                            <div class="label">
                                <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" 
                                          stroke="currentColor" stroke-width="2" fill="none"/>
                                    <circle cx="12" cy="9" r="2.5" stroke="currentColor" stroke-width="2" fill="none"/>
                                </svg>
                                <strong>Ø¢Ø¯Ø±Ø³{% if all_addresses|length > 1 %}â€ŒÙ‡Ø§{% endif %}:</strong>
                            </div>
                            <div class="addresses-list">
                                {% for address in all_addresses %}
                                    <div class="address-item">{{ address }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% endwith %}
                        
                        <div class="row orders-row">
                            <div class="label">
                                <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2" 
                                          stroke="currentColor" stroke-width="2" fill="none"/>
                                </svg>
                                <strong>Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´Ø§Øª:</strong>
                            </div>
                            <div class="order-ids-list">
                                {% if customer.orders.all %}
                                    {% for order in customer.orders.all %}
                                        <a href="{% url 'order_list_url' %}#order-{{ order.id }}" 
                                           class="order-id-badge" 
                                           title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´ #{{ order.id }}"
                                           style="display: inline-block; position: relative; z-index: 100; pointer-events: auto; cursor: pointer;"
                                           onclick="console.log('ğŸ”— Clicked order link: #order-{{ order.id }}', this.href);">
                                            #{{ order.id }}
                                        </a>
                                    {% endfor %}
                                {% else %}
                                    <span class="no-orders-text">Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="label">
                                <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 8v5l3 3" stroke="currentColor" stroke-width="2"
                                          stroke-linecap="round"/>
                                </svg>
                                <strong>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:</strong>
                            </div>
                            <div>{{ customer.updated_at|jalali_datetime }}</div>
                        </div>
                    </div>
                </article>
            {% empty %}
                <div class="no-customers">
                    <p>Ù‡ÛŒÚ† Ù…Ø´ØªØ±ÛŒÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
                </div>
            {% endfor %}
        </section>
    </div>
    
    <script>
        // Delete customer function
        function deleteCustomer(customerId, customerName, customerPhone) {
            if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù…Ø´ØªØ±ÛŒ "${customerName}" (${customerPhone}) Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ\n\nØ§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.`)) {
                return;
            }
            
            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             getCookie('csrftoken');
            
            // Send DELETE request
            fetch(`/api/customers/${customerId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    // Reload the page to show updated list
                    window.location.reload();
                } else if (data.error) {
                    alert('Ø®Ø·Ø§: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù…Ø´ØªØ±ÛŒ. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
            });
        }
        
        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Debug: Log all order ID links on page load and ensure they're clickable
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure delete buttons are clickable
            const deleteButtons = document.querySelectorAll('.delete-customer-btn');
            console.log('ğŸ—‘ï¸ Delete buttons found:', deleteButtons.length);
            deleteButtons.forEach((btn, index) => {
                console.log(`  Delete button ${index + 1}:`, {
                    onclick: btn.getAttribute('onclick'),
                    computedStyle: window.getComputedStyle(btn).pointerEvents,
                    zIndex: window.getComputedStyle(btn).zIndex
                });
                
                // Force ensure button is clickable
                btn.style.pointerEvents = 'auto';
                btn.style.cursor = 'pointer';
                btn.style.zIndex = '100';
                btn.style.position = 'relative';
                
                // Add click event listener
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent event bubbling
                    const customerId = this.getAttribute('data-customer-id');
                    const customerName = this.getAttribute('data-customer-name');
                    const customerPhone = this.getAttribute('data-customer-phone');
                    console.log('âœ… Delete button clicked!', {
                        customerId: customerId,
                        customerName: customerName,
                        customerPhone: customerPhone
                    });
                    deleteCustomer(parseInt(customerId), customerName, customerPhone);
                }, true);
            });
            
            const orderLinks = document.querySelectorAll('.order-id-badge');
            console.log('ğŸ”— Order ID links found:', orderLinks.length);
            orderLinks.forEach((link, index) => {
                console.log(`  Link ${index + 1}:`, {
                    href: link.href,
                    text: link.textContent.trim(),
                    computedStyle: window.getComputedStyle(link).pointerEvents,
                    zIndex: window.getComputedStyle(link).zIndex
                });
                
                // Force ensure link is clickable
                link.style.pointerEvents = 'auto';
                link.style.cursor = 'pointer';
                link.style.zIndex = '100';
                link.style.position = 'relative';
                
                // Test if link is clickable - add multiple event listeners
                link.addEventListener('click', function(e) {
                    console.log('âœ… Link clicked!', {
                        href: this.href,
                        text: this.textContent.trim(),
                        event: e
                    });
                    // Don't prevent default - let the link work naturally
                }, true); // Use capture phase
                
                link.addEventListener('mousedown', function(e) {
                    console.log('ğŸ–±ï¸ Mouse down on link:', this.href);
                });
            });
            
            // Also check for any overlays that might block clicks
            const customerCards = document.querySelectorAll('.customer-card');
            customerCards.forEach(card => {
                const computedStyle = window.getComputedStyle(card);
                if (computedStyle.pointerEvents === 'none') {
                    console.warn('âš ï¸ Customer card has pointer-events: none');
                }
            });
        });
    </script>
{% endblock %}

