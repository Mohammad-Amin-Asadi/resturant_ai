{% extends 'base.html' %}
{% load static %}

{% block title %}
    Ø³ÙØ§Ø±Ø´Ø§Øª Ø±Ø³ØªÙˆØ±Ø§Ù†
{% endblock %}

{% block stylesheet %}
    <link rel="stylesheet" href="{% static 'orders_list_style.css' %}">
{% endblock %}

{% block content %}
    <div class="container">
        <header>
            <div class="brand">
                <div class="logo" aria-hidden="true"></div>
                <div>
                    <h1>Ø³ÙØ§Ø±Ø´Ø§Øª Ø±Ø³ØªÙˆØ±Ø§Ù† Ø¨Ø²Ø±Ú¯Ù…Ù‡Ø±</h1>
                    <div class="subtitle">Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´Ø§Øª</div>
                </div>
            </div>
            <div class="actions">
                <a class="btn" href="{% url 'customers_list_url' %}" data-tip="Ù…Ø´ØªØ±ÛŒØ§Ù†">
                    Ù…Ø´ØªØ±ÛŒØ§Ù†
                </a>
            </div>
        </header>

        <!-- Orders -->
        <section class="orders">
            {% for order in orders %}
                <article id="order-{{ order.id }}" class="card order-card" data-status="{{ order.status }}" style="--delay:.02s; scroll-margin-top: 100px;">
                    <div class="card-head">
                        <div style="display:flex; gap:10px; align-items:center; justify-content: space-between; width: 100%;">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <div class="avatar" aria-hidden="true">
                                    <svg
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            xmlns="http://www.w3.org/2000/svg"
                                    >
                                        <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5Zm0 2c-4.418 0-8 2.239-8 5v2h16v-2c0-2.761-3.582-5-8-5Z"
                                              fill="currentColor" opacity=".7"/>
                                    </svg>
                                </div>
                                <div>
                                    <div class="name">{{ order.customer_name }}</div>
                                    <div class="phone">{{ order.phone_number }}</div>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <div class="order-number">
                                    <strong>#{{ order.id }}</strong>
                                </div>
                                <button class="delete-order-btn" 
                                        data-order-id="{{ order.id }}"
                                        onclick="deleteOrder(this)"
                                        title="Ø­Ø°Ù Ø³ÙØ§Ø±Ø´"
                                        aria-label="Ø­Ø°Ù Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§Ø±Ù‡ {{ order.id }}">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9 3v1H4v2h1v13a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V6h1V4h-5V3H9zm2 2h2v1h-2V5zm-1 3v11h2V8h-2zm4 0v11h2V8h-2z" 
                                              fill="currentColor" opacity="0.8"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="rows">
                        <div class="row">
                            <div class="label">
                                <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 8v5l3 3" stroke="currentColor" stroke-width="2"
                                          stroke-linecap="round"/>
                                </svg>
                                <strong>ØªØ§Ø±ÛŒØ®:</strong>
                            </div>
                            <div>{{ order.order_date|date:"Y-m-d H:i" }}</div>
                        </div>
                        
                        <div class="row items-row">
                            <div class="label">
                                <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 12l9-9 9 9-9 9-9-9Z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                <strong>Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§:</strong>
                            </div>
                            <div class="items-list">
                                {% for item in order.items.all %}
                                    <div class="order-item">
                                        <span class="item-name">{{ item.menu_item.name }}</span>
                                        <span class="item-qty">Ã— {{ item.quantity }}</span>
                                        <span class="item-price">{{ item.subtotal|floatformat:0 }} ØªÙˆÙ…Ø§Ù†</span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% if order.address %}
                        <div class="row">
                            <div class="label">
                                <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" 
                                          stroke="currentColor" stroke-width="2" fill="none"/>
                                    <circle cx="12" cy="9" r="2.5" stroke="currentColor" stroke-width="2" fill="none"/>
                                </svg>
                                <strong>Ø¢Ø¯Ø±Ø³:</strong>
                            </div>
                            <div>{{ order.address }}</div>
                        </div>
                        {% endif %}
                        
                        <div class="row total-row">
                            <div class="label">
                                <strong>Ø¬Ù…Ø¹ Ú©Ù„:</strong>
                            </div>
                            <div class="total-price">{{ order.total_price|floatformat:0 }} ØªÙˆÙ…Ø§Ù†</div>
                        </div>
                        
                        <div class="row status-row">
                            <div class="label">
                                <strong>ÙˆØ¶Ø¹ÛŒØª:</strong>
                            </div>
                            <div class="status-selector">
                                <div class="status-radios">
                                    <label class="radio-option status-pending">
                                        <input type="radio" name="status_{{ order.id }}" value="pending" 
                                               data-order-id="{{ order.id }}"
                                               {% if order.status == 'pending' %}checked{% endif %}
                                               onchange="updateOrderStatus(this)">
                                        <span class="radio-label">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯</span>
                                    </label>
                                    
                                    <label class="radio-option status-confirmed">
                                        <input type="radio" name="status_{{ order.id }}" value="confirmed" 
                                               data-order-id="{{ order.id }}"
                                               {% if order.status == 'confirmed' %}checked{% endif %}
                                               onchange="updateOrderStatus(this)">
                                        <span class="radio-label">ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>
                                    </label>
                                    
                                    <label class="radio-option status-preparing">
                                        <input type="radio" name="status_{{ order.id }}" value="preparing" 
                                               data-order-id="{{ order.id }}"
                                               {% if order.status == 'preparing' %}checked{% endif %}
                                               onchange="updateOrderStatus(this)">
                                        <span class="radio-label">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ</span>
                                    </label>
                                    
                                    <label class="radio-option status-on_delivery">
                                        <input type="radio" name="status_{{ order.id }}" value="on_delivery" 
                                               data-order-id="{{ order.id }}"
                                               {% if order.status == 'on_delivery' %}checked{% endif %}
                                               onchange="updateOrderStatus(this)">
                                        <span class="radio-label">ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ Ù¾ÛŒÚ©</span>
                                    </label>
                                    
                                    <label class="radio-option status-delivered">
                                        <input type="radio" name="status_{{ order.id }}" value="delivered" 
                                               data-order-id="{{ order.id }}"
                                               {% if order.status == 'delivered' %}checked{% endif %}
                                               onchange="updateOrderStatus(this)">
                                        <span class="radio-label">ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ</span>
                                    </label>
                                    
                                    <label class="radio-option status-cancelled">
                                        <input type="radio" name="status_{{ order.id }}" value="cancelled" 
                                               data-order-id="{{ order.id }}"
                                               {% if order.status == 'cancelled' %}checked{% endif %}
                                               onchange="updateOrderStatus(this)">
                                        <span class="radio-label">Ù„ØºÙˆ Ø´Ø¯Ù‡</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        {% if order.notes %}
                        <div class="row">
                            <div class="label">
                                <strong>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª:</strong>
                            </div>
                            <div>{{ order.notes }}</div>
                        </div>
                        {% endif %}
                    </div>
                </article>
            {% empty %}
                <div class="no-orders">
                    <p>Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
                </div>
            {% endfor %}
        </section>
    </div>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            console.log(`Cookie '${name}':`, cookieValue);
            return cookieValue;
        }

        function updateOrderStatus(radioElement) {
            console.log('âœ… updateOrderStatus called');
            const orderId = radioElement.dataset.orderId;
            const newStatus = radioElement.value;
            const csrftoken = getCookie('csrftoken');
            
            console.log('ğŸ“‹ Order ID:', orderId);
            console.log('ğŸ”„ New Status:', newStatus);
            console.log('ğŸ”‘ CSRF Token:', csrftoken ? 'Present' : 'MISSING');
            
            if (!csrftoken) {
                alert('Ø®Ø·Ø§: ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.');
                location.reload();
                return;
            }
            
            // Disable all radio buttons for this order temporarily
            const allRadios = document.querySelectorAll(`input[name="status_${orderId}"]`);
            allRadios.forEach(r => r.disabled = true);
            
            fetch(`/api/orders/${orderId}/status/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => {
                console.log('ğŸ“¡ Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('âœ… Success! Response data:', data);
                
                // Update the card's data-status attribute for visual feedback
                const card = radioElement.closest('.order-card');
                if (card) {
                    card.setAttribute('data-status', newStatus);
                }
                
                // Re-enable radio buttons
                allRadios.forEach(r => r.disabled = false);
                
                console.log('âœ… ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ #' + orderId + ' Ø¨Ù‡ "' + newStatus + '" ØªØºÛŒÛŒØ± Ú©Ø±Ø¯');
            })
            .catch(error => {
                console.error('âŒ Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´: ' + error.message);
                
                // Re-enable and reset to original state
                allRadios.forEach(r => r.disabled = false);
                location.reload();
            });
        }

        function deleteOrder(buttonElement) {
            console.log('ğŸ—‘ï¸ deleteOrder called');
            const orderId = buttonElement.dataset.orderId;
            const csrftoken = getCookie('csrftoken');
            
            console.log('ğŸ“‹ Order ID to delete:', orderId);
            console.log('ğŸ”‘ CSRF Token:', csrftoken ? 'Present' : 'MISSING');
            
            if (!csrftoken) {
                alert('Ø®Ø·Ø§: ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.');
                location.reload();
                return;
            }
            
            // Confirm deletion
            if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø³ÙØ§Ø±Ø´ #${orderId} Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ\n\nØ§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.`)) {
                console.log('âŒ Deletion cancelled by user');
                return;
            }
            
            // Disable button during deletion
            buttonElement.disabled = true;
            buttonElement.style.opacity = '0.5';
            
            // Find the order card for removal
            const orderCard = buttonElement.closest('.order-card');
            
            fetch(`/api/orders/${orderId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => {
                console.log('ğŸ“¡ Delete response status:', response.status);
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('âœ… Success! Order deleted:', data);
                
                // Remove the order card from the page with animation
                if (orderCard) {
                    orderCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    orderCard.style.opacity = '0';
                    orderCard.style.transform = 'translateX(-20px)';
                    
                    setTimeout(() => {
                        orderCard.remove();
                        
                        // Check if there are no more orders
                        const remainingOrders = document.querySelectorAll('.order-card');
                        if (remainingOrders.length === 0) {
                            // Reload to show "no orders" message
                            location.reload();
                        }
                    }, 300);
                } else {
                    // Fallback: reload page if card not found
                    location.reload();
                }
            })
            .catch(error => {
                console.error('âŒ Error deleting order:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³ÙØ§Ø±Ø´: ' + error.message);
                
                // Re-enable button
                buttonElement.disabled = false;
                buttonElement.style.opacity = '1';
            });
        }
        
        // Auto-refresh every 30 seconds
        setTimeout(() => location.reload(), 30000);
        
        // Log cookies on page load
        console.log('All cookies:', document.cookie);
        
        // Scroll to order if hash is present in URL
        function scrollToOrder(retryCount = 0) {
            const hash = window.location.hash;
            const fullUrl = window.location.href;
            console.log('ğŸ” Checking hash:', hash);
            console.log('ğŸ”— Full URL:', fullUrl);
            
            if (hash && hash.startsWith('#order-')) {
                const orderId = hash.substring(7); // Remove '#order-' prefix
                console.log('ğŸ“‹ Looking for order ID:', orderId);
                
                // Try multiple methods to find the element
                let orderElement = document.getElementById(`order-${orderId}`);
                
                // Fallback: try querySelector
                if (!orderElement) {
                    orderElement = document.querySelector(`[id="order-${orderId}"]`);
                }
                
                // Fallback: try by data attribute
                if (!orderElement) {
                    const allCards = document.querySelectorAll('.order-card');
                    for (let card of allCards) {
                        if (card.id === `order-${orderId}`) {
                            orderElement = card;
                            break;
                        }
                    }
                }
                
                if (orderElement) {
                    console.log('âœ… Found order element:', orderElement);
                    console.log('ğŸ“ Element position:', {
                        top: orderElement.offsetTop,
                        id: orderElement.id,
                        visible: orderElement.offsetParent !== null
                    });
                    
                    // Wait for animations and page to fully render
                    const delay = 500 + (retryCount * 200);
                    setTimeout(() => {
                        // Prevent any default scroll behavior
                        window.scrollTo(0, 0);
                        
                        // Small delay to let browser settle
                        setTimeout(() => {
                            // Calculate position manually for more control
                            const elementTop = orderElement.offsetTop;
                            const elementHeight = orderElement.offsetHeight;
                            const windowHeight = window.innerHeight;
                            const scrollPosition = elementTop - (windowHeight / 2) + (elementHeight / 2) - 50; // 50px offset for header
                            
                            // Scroll to the element
                            window.scrollTo({
                                top: Math.max(0, scrollPosition),
                                behavior: 'smooth'
                            });
                            
                            // Also use scrollIntoView as backup
                            orderElement.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center',
                                inline: 'nearest'
                            });
                            
                            // Small additional delay to ensure scroll completes
                            setTimeout(() => {
                                // Highlight the order card temporarily
                                const originalBoxShadow = orderElement.style.boxShadow || '';
                                const originalBorder = orderElement.style.border || '';
                                const originalTransform = orderElement.style.transform || '';
                                
                                orderElement.style.transition = 'all 0.3s ease';
                                orderElement.style.boxShadow = '0 0 20px rgba(74, 163, 255, 0.6), 0 14px 40px rgba(0, 0, 0, .45)';
                                orderElement.style.border = '2px solid var(--brand)';
                                orderElement.style.transform = 'scale(1.02)';
                                
                                // Remove highlight after 3 seconds
                                setTimeout(() => {
                                    orderElement.style.boxShadow = originalBoxShadow;
                                    orderElement.style.border = originalBorder;
                                    orderElement.style.transform = originalTransform;
                                }, 3000);
                            }, 200);
                        }, 50);
                    }, delay);
                } else {
                    console.log(`âš ï¸ Order #${orderId} not found on page (attempt ${retryCount + 1})`);
                    // Debug: show what IDs are available
                    const allIds = Array.from(document.querySelectorAll('[id^="order-"]')).map(el => el.id);
                    console.log('ğŸ” Available order IDs:', allIds);
                    
                    // Retry up to 5 times with increasing delays (in case page is still loading)
                    if (retryCount < 5) {
                        setTimeout(() => {
                            scrollToOrder(retryCount + 1);
                        }, 300);
                    } else {
                        console.error(`âŒ Order #${orderId} not found after ${retryCount + 1} attempts`);
                        console.error('Available IDs:', allIds);
                    }
                }
            } else if (hash) {
                console.log('âš ï¸ Hash found but does not match #order- pattern:', hash);
            }
        }
        
        // Prevent default browser scroll behavior on hash navigation
        if (window.location.hash) {
            // Temporarily remove hash to prevent browser auto-scroll
            const hash = window.location.hash;
            history.replaceState(null, null, window.location.pathname + window.location.search);
            // Restore hash after a moment
            setTimeout(() => {
                history.replaceState(null, null, hash);
            }, 50);
        }
        
        // Run on page load with multiple strategies
        function initScrollToOrder() {
            // Strategy 1: If DOM is already loaded
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                setTimeout(() => scrollToOrder(), 200);
            } else {
                // Strategy 2: Wait for DOMContentLoaded
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(() => scrollToOrder(), 300);
                });
            }
            
            // Strategy 3: Also try on window load (after all resources loaded)
            window.addEventListener('load', () => {
                setTimeout(() => scrollToOrder(), 400);
            });
        }
        
        // Initialize immediately
        initScrollToOrder();
        
        // Also handle hash changes (if user clicks another order link)
        window.addEventListener('hashchange', () => {
            console.log('ğŸ”„ Hash changed, scrolling to new order');
            scrollToOrder();
        });
        
        // Handle case where hash is already in URL when page loads
        if (window.location.hash) {
            console.log('ğŸ“ Hash present on initial load:', window.location.hash);
        }
        
        // Debug: Log all order IDs on the page
        function debugOrderIds() {
            const allOrderCards = document.querySelectorAll('[id^="order-"]');
            console.log('ğŸ“Š Total order cards found:', allOrderCards.length);
            const orderIds = Array.from(allOrderCards).map(card => card.id);
            console.log('ğŸ“‹ All order IDs on page:', orderIds);
        }
        
        // Run debug after page loads
        setTimeout(debugOrderIds, 1000);
    </script>
{% endblock %}

