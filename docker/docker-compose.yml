services:
  # PostgreSQL Database
  postgres:
    image: postgres:17-alpine
    container_name: avatabot-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-server_db}
      POSTGRES_USER: ${POSTGRES_USER:-avatabot_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      TZ: ${TZ:-Asia/Tehran}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Port mapping: By default uses 5433 on host to avoid conflicts with system PostgreSQL
    # Services inside Docker network use 'postgres:5432' (no host port needed)
    # To change host port, set POSTGRES_PORT env var (e.g., POSTGRES_PORT=5434)
    # To disable port mapping, comment out the ports section below
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-avatabot_user} -d ${POSTGRES_DB:-server_db}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - avatabot-network

  # Django Backend - Restaurant Service (Port 8080)
  backend-restaurant:
    build:
      context: ../avatabot_web
      dockerfile: Dockerfile
    container_name: avatabot-backend-restaurant
    restart: unless-stopped
    environment:
      # Django Security
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG:-False}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1,backend-restaurant}
      # Database (use service name)
      DB_NAME: ${POSTGRES_DB:-server_db}
      DB_USER: ${POSTGRES_USER:-avatabot_user}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_HOST: postgres
      DB_PORT: 5432
      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS:-http://localhost:8080}
      # SMS (optional - can be in tenant config)
      SMS_API_URL: ${SMS_API_URL:-https://api.limosms.com/api/sendsms}
      SMS_API_KEY: ${SMS_API_KEY:-}
      SMS_SENDER_NUMBER: ${SMS_SENDER_NUMBER:-}
      # Weather (optional - can be in tenant config)
      WEATHER_API_URL: ${WEATHER_API_URL:-https://one-api.ir/weather/}
      WEATHER_API_TOKEN: ${WEATHER_API_TOKEN:-}
      # Timezone
      TZ: ${TZ:-Asia/Tehran}
      # Service Type: restaurant
      SERVER_TYPE: restaurant
    volumes:
      - backend_static:/app/staticfiles
      - backend_media:/app/media
    ports:
      - "${RESTAURANT_PORT:-8080}:8000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; response = urllib.request.urlopen('http://localhost:8000/healthz/', timeout=5); assert response.getcode() == 200\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - avatabot-network

  # Django Backend - Taxi Service (Port 8081)
  backend-taxi:
    build:
      context: ../avatabot_web
      dockerfile: Dockerfile
    container_name: avatabot-backend-taxi
    restart: unless-stopped
    environment:
      # Django Security
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG:-False}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1,backend-taxi}
      # Database (use service name)
      DB_NAME: ${POSTGRES_DB:-server_db}
      DB_USER: ${POSTGRES_USER:-avatabot_user}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_HOST: postgres
      DB_PORT: 5432
      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS:-http://localhost:8081}
      # SMS (optional - can be in tenant config)
      SMS_API_URL: ${SMS_API_URL:-https://api.limosms.com/api/sendsms}
      SMS_API_KEY: ${SMS_API_KEY:-}
      SMS_SENDER_NUMBER: ${SMS_SENDER_NUMBER:-}
      # Weather (optional - can be in tenant config)
      WEATHER_API_URL: ${WEATHER_API_URL:-https://one-api.ir/weather/}
      WEATHER_API_TOKEN: ${WEATHER_API_TOKEN:-}
      # Timezone
      TZ: ${TZ:-Asia/Tehran}
      # Service Type: taxi
      SERVER_TYPE: taxi
    volumes:
      - backend_static:/app/staticfiles
      - backend_media:/app/media
    ports:
      - "${TAXI_PORT:-8081}:8000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; response = urllib.request.urlopen('http://localhost:8000/healthz/', timeout=5); assert response.getcode() == 200\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - avatabot-network

  # OpenSIPS SIP Proxy/B2BUA
  opensips:
    image: opensips/opensips:latest
    container_name: avatabot-opensips
    restart: unless-stopped
    volumes:
      - ../opensip_stabel/engine/cfg/opensips.cfg:/etc/opensips/opensips.cfg:ro
      - opensips_logs:/var/log/opensips
    ports:
      - "${SIP_PORT:-5060}:5060/udp"
      - "${SIP_PORT:-5060}:5060/tcp"
      - "${MI_PORT:-8080}:8080/udp"
    networks:
      - avatabot-network
    command: ["-f", "/etc/opensips/opensips.cfg", "-F"]

  # AI Engine / OpenSIPS Bridge
  engine:
    build:
      context: ../opensip_stabel/engine
      dockerfile: Dockerfile
    container_name: avatabot-engine
    restart: unless-stopped
    environment:
      # Backend URL (use restaurant service name - internal port is always 8000)
      BACKEND_SERVER_URL: ${BACKEND_SERVER_URL:-http://backend-restaurant:8000}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      # Soniox STT (optional)
      SONIOX_API_KEY: ${SONIOX_API_KEY:-}
      # SMS (LimoSMS API)
      SMS_API_URL: ${SMS_API_URL:-https://api.limosms.com/api/sendsms}
      SMS_API_KEY: ${SMS_API_KEY:-8dd73576-e25c-4624-aba2-b0ed72bfab89}
      SMS_SENDER_NUMBER: ${SMS_SENDER_NUMBER:-}
      # DID Config Directory
      DID_CONFIG_DIR: /app/config/did
      # Config File (optional)
      CONFIG_FILE: ${CONFIG_FILE:-}
      # OpenSIPS Connection (if using external OpenSIPS)
      OPENSIPS_MI_SOCKET: ${OPENSIPS_MI_SOCKET:-}
      OPENSIPS_EVENT_SOCKET: ${OPENSIPS_EVENT_SOCKET:-}
      # Engine Event Listener (for OpenSIPS events)
      # Use fixed port 5061 for production (exposed to host)
      EVENT_IP: ${EVENT_IP:-0.0.0.0}
      EVENT_PORT: ${EVENT_PORT:-5061}
      # OpenSIPS MI (Management Interface) - where engine connects TO OpenSIPS
      # If OpenSIPS is in Docker: use service name (opensips)
      # If OpenSIPS is on host: use host.docker.internal or actual host IP
      MI_IP: ${MI_IP:-opensips}
      MI_PORT: ${MI_PORT:-8080}
      # RTP Settings
      RTP_PUBLIC_IP: ${RTP_PUBLIC_IP:-}
      RTP_BIND_IP: ${RTP_BIND_IP:-0.0.0.0}
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      # Timezone
      TZ: ${TZ:-Asia/Tehran}
    volumes:
      - ../opensip_stabel/engine/config/did:/app/config/did:ro
      - engine_logs:/app/logs
      # Optionally mount src for development (uncomment for live code reloading)
      # - ../opensip_stabel/engine/src:/app/src
    depends_on:
      - backend-restaurant
      - opensips
    networks:
      - avatabot-network
    # Expose event port (optional - only needed if accessing from outside Docker network)
    ports:
      - "${EVENT_PORT:-5061}:${EVENT_PORT:-5061}/udp"
    # Note: Engine listens for OpenSIPS events on EVENT_IP:EVENT_PORT (default: 0.0.0.0:5061)
    # OpenSIPS (in Docker) connects via service name: avatabot-engine:5061
    # Engine connects to OpenSIPS MI on MI_IP:MI_PORT (default: opensips:8080)

volumes:
  postgres_data:
    driver: local
  backend_static:
    driver: local
  backend_media:
    driver: local
  engine_logs:
    driver: local
  opensips_logs:
    driver: local

networks:
  avatabot-network:
    driver: bridge
